<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DB Admin ‚Ä¢ Supabase (Safe)</title>
  <style>
    .clock .date{ opacity:.75; margin-right:8px }
    .clock .time{ font-weight:800 }

    :root{
      --bg:#f6f7fb; --fg:#0b1220; --muted:#64748b; --card:#ffffff; --border:#e5e7eb;
      --accent:#2563eb; --accent-2:#1e40af; --danger:#dc2626; --success:#059669;
      --board-h:#f1f5f9; --row-a:#ffffff; --row-b:#f9fafb; --shadow:0 10px 30px rgba(2,6,23,.06);
      --focus:#93c5fd; --chip:#f8fafc; --ctl-h:42px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.65 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    h1{margin:0 0 14px;font-size:26px;letter-spacing:.2px}
    .info-bar,.bar{display:flex;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);padding:8px 12px;border-radius:999px;font-weight:700}
    .muted{color:var(--muted)}
    .clock{margin-left:auto;font-weight:800;letter-spacing:.5px}
    .spacer{flex:1}

    input[type="search"], input[type="text"], input[type="email"], input[type="datetime-local"], select, textarea{
      height:var(--ctl-h); padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--fg);outline:none;min-width:220px;
      transition:border-color .15s, box-shadow .15s, background .15s
    }
    input:focus, select:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--focus)}
    button{
      height:var(--ctl-h); padding:0 14px;border:none;border-radius:12px;cursor:pointer;font-weight:700;
      transition:transform .06s, box-shadow .15s, background-color .15s, color .15s
    }
    button:active{transform:translateY(1px)}
    .btn{background:var(--accent);color:#fff;box-shadow:0 2px 10px rgba(37,99,235,.18)}
    .btn:hover{background:var(--accent-2)}
    .btn-ghost{background:#fff;color:var(--fg);border:1px solid var(--border)}
    .btn-ghost:hover{box-shadow:0 2px 10px rgba(2,6,23,.08)}
    .btn-del{background:var(--danger);color:#fff}
    .btn:disabled,.btn-ghost:disabled,.btn-del:disabled{opacity:.5; cursor:not-allowed; box-shadow:none}

    .board{margin-top:12px;border:1px solid var(--border);border-radius:14px;overflow:auto;box-shadow:var(--shadow);background:var(--card)}
    table{width:100%;border-collapse:collapse;font-size:14px;table-layout:auto;min-width:900px}
    thead th{background:var(--board-h);text-transform:uppercase;letter-spacing:.35px;padding:10px;border-bottom:1px solid var(--border);color:#334155;font-weight:800;position:sticky;top:0;z-index:1}
    tbody td{padding:10px;border-bottom:1px solid var(--border);color:#0f172a;vertical-align:top}
    tbody tr:nth-child(odd){background:var(--row-a)} tbody tr:nth-child(even){background:var(--row-b)}
    td[contenteditable="true"]{outline:none}
    td[contenteditable="true"]:focus{box-shadow: inset 0 0 0 2px var(--focus)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .notice{margin-top:8px;color:#b45309;font-size:13px}

    /* Tabs */
    .tabs{display:flex; gap:8px; margin:12px 0}
    .tab{padding:8px 14px; border:1px solid var(--border); border-radius:999px; background:#fff; cursor:pointer; font-weight:700}
    .tab.active{background:var(--accent); color:#fff; border-color:var(--accent)}
    .panel{display:none}
    .panel.active{display:block}

    /* Audit toolbar (2 ‡πÅ‡∏ñ‡∏ß) */
    .audit-toolbar{
      display:grid; gap:12px; align-items:end;
      grid-template-columns: auto repeat(5, minmax(180px,1fr));
      grid-template-areas:
        "actions f1 f2 f3 f4 f5"
        "pg      pg pg pg pg pg";
      width:100%;
    }
    .audit-actions{grid-area:actions; display:flex; gap:10px; align-items:center; justify-self:start; justify-content:flex-start}
    .at-f1{grid-area:f1} .at-f2{grid-area:f2} .at-f3{grid-area:f3}
    .at-f4{grid-area:f4} .at-f5{grid-area:f5}
    .pagination-wrap{grid-area:pg; display:flex; align-items:center; gap:8px; justify-content:flex-end}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:0 10px; height:var(--ctl-h); border:1px solid var(--border); border-radius:999px; background:#fff; font-size:12px}

    .diff{font-size:13px; background:#0b1220; color:#e5e7eb; padding:8px; border-radius:8px; margin-top:6px; overflow:auto}
    .k{color:#93c5fd} .v-old{color:#fca5a5} .v-new{color:#86efac}

    @media (max-width:900px){
      .audit-toolbar{
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "actions actions"
          "f1 f2"
          "f3 f4"
          "f5 f5"
          "pg pg";
      }
    }
    @media (max-width:720px){
      .wrap{padding:12px}
      .clock{margin-left:0}
      input[type="search"]{min-width:160px;flex:1}
      .bar{flex-wrap:wrap}
      table{font-size:13px}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1>DB Admin ‚Ä¢ Supabase</h1>

    <!-- Summary -->
    <div class="info-bar">
      <div class="chip">üì¶ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: <span id="tableCount" class="mono">‚Äî</span></div>
      <div class="chip">üßë ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span id="userEmail" class="mono">‚Äî</span></div>
      <div class="clock" id="clock">--:--:--</div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tabData" class="tab active" title="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">üìÅ Data</button>
      <button id="tabAudit" class="tab" title="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)">üïµÔ∏è Audit Logs</button>
    </div>

    <!-- ===== DATA ===== -->
    <div id="panelData" class="panel active">
      <div class="bar" style="margin-top:12px">
        <label class="muted">‡∏ï‡∏≤‡∏£‡∏≤‡∏á</label>
        <select id="tableSelect"></select>

        <button class="btn" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn-ghost" id="btnAddRow">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
        <button class="btn-ghost" id="btnSaveEdits">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="btn-del" id="btnDeleteRows">‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>

        <span class="spacer"></span>
        <input id="search" type="search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)" autocomplete="off" />
        <button class="btn-ghost" id="btnExport">‚¨áÔ∏è CSV</button>
        <button class="btn-del" id="btnLogout">üö™ Logout</button>
      </div>

      <div class="board">
        <table aria-label="‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
          <thead id="thead"></thead>
          <tbody id="tbody"><tr><td class="muted" style="padding:12px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</td></tr></tbody>
        </table>
      </div>

      <div class="foot">
        <div id="countLabel" class="muted">‚Äî</div>
        <div class="muted">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">‚Äî</span></div>
      </div>
      <div id="notice" class="notice"></div>
    </div>

    <!-- ===== AUDIT (READ-ONLY) ===== -->
    <div id="panelAudit" class="panel">
      <div class="bar" style="margin-top:12px">
        <div class="audit-toolbar">
          <div class="at-f1" style="display:flex; flex-direction:column; gap:6px">
            <label class="muted">‡∏ï‡∏≤‡∏£‡∏≤‡∏á (target_table)</label>
            <input id="afTable" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô qrcodes (‡∏ß‡πà‡∏≤‡∏á=‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)" />
          </div>
          <div class="at-f2" style="display:flex; flex-direction:column; gap:6px">
            <label class="muted">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
            <input id="afEmail" type="email" placeholder="‡πÄ‡∏ä‡πà‡∏ô admin@example.com (‡∏ß‡πà‡∏≤‡∏á=‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)" />
          </div>
          <div class="at-f3" style="display:flex; flex-direction:column; gap:6px">
            <label class="muted">Action</label>
            <select id="afAction">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option>INSERT</option>
              <option>UPDATE</option>
              <option>DELETE</option>
              <option>SQL</option>
            </select>
          </div>
          <div class="at-f4" style="display:flex; flex-direction:column; gap:6px">
            <label class="muted">‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
            <input id="afFrom" type="datetime-local" />
          </div>
          <div class="at-f5" style="display:flex; flex-direction:column; gap:6px">
            <label class="muted">‡∏ñ‡∏∂‡∏á</label>
            <input id="afTo" type="datetime-local" />
          </div>
        </div>
      </div>

      <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡∏õ‡∏∏‡πà‡∏° (‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î) + ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
      <div class="audit-actions" style="margin:8px 0 12px">
        <button class="btn" id="btnAuditSearch">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        <button class="btn-ghost" id="btnAuditReset">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        <button class="btn-ghost" id="btnAuditRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      </div>

      <div class="board">
        <table aria-label="audit logs">
          <thead>
            <tr>
              <th style="min-width:160px">‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏ú‡∏π‡πâ‡πÅ‡∏Å‡πâ</th>
              <th>Action</th>
              <th>Table / PK</th>
              <th>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</th>
              <th>Diff</th>
              <th>Meta</th>
            </tr>
          </thead>
          <tbody id="auditBody">
            <tr><td class="muted" style="padding:12px">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>
          </tbody>
        </table>
      </div>

      <div class="foot">
        <div id="auditCount" class="muted">‚Äî</div>
        <div class="muted">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="auditLast" class="mono">‚Äî</span></div>
      </div>

      <!-- ‡πÄ‡∏û‡∏à‡∏à‡∏¥‡πâ‡∏á -->
      <div class="pagination-wrap" style="margin-top:8px">
        <div class="pill">‡∏´‡∏ô‡πâ‡∏≤: <span id="auditPageCur" class="mono">1</span> / <span id="auditPageMax" class="mono">1</span></div>
        <button class="btn-ghost" id="btnAuditPrev" title="‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">‚óÄ</button>
        <button class="btn-ghost" id="btnAuditNext" title="‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">‚ñ∂</button>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const SUPABASE_URL = "https://yowjvmiosrclqstoeqat.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvd2p2bWlvc3JjbHFzdG9lcWF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMDc0OTksImV4cCI6MjA3MzU4MzQ5OX0.p71LqTM5gaJcpaAMMnWzLgsLNAka0nmR7BYntBiSYfU";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ---------- CONSTANTS ---------- */
const AUDIT_TABLE = "audit_logs";
const AUDIT_ORDER_PREF = ["event_ts","created_at","inserted_at","id"];
const AUDIT_PAGE_SIZE = 50;

const tz='Asia/Bangkok';
const fmtTime = new Intl.DateTimeFormat('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:tz});
const fmtFull = new Intl.DateTimeFormat('th-TH',{dateStyle:'medium', timeStyle:'medium', hour12:false, timeZone:tz});

/* ---------- Elements (Data) ---------- */
const tableSelect = document.getElementById('tableSelect');
const tableCount  = document.getElementById('tableCount');
const userEmail   = document.getElementById('userEmail');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const btnRefresh = document.getElementById('btnRefresh');
const btnAddRow  = document.getElementById('btnAddRow');
const btnSaveEdits = document.getElementById('btnSaveEdits');
const btnDeleteRows = document.getElementById('btnDeleteRows');
const btnExport  = document.getElementById('btnExport');
const btnLogout  = document.getElementById('btnLogout');
const search = document.getElementById('search');
const countLabel = document.getElementById('countLabel');
const lastUpdate = document.getElementById('lastUpdate');
const notice = document.getElementById('notice');
const clock = document.getElementById('clock');
const fmtDate = new Intl.DateTimeFormat('th-TH', { dateStyle:'medium', timeZone: tz });

/* ---------- Tabs ---------- */
const tabData = document.getElementById('tabData');
const tabAudit = document.getElementById('tabAudit');
const panelData = document.getElementById('panelData');
const panelAudit = document.getElementById('panelAudit');

/* ---------- Audit elements ---------- */
const afTable = document.getElementById('afTable');
const afEmail = document.getElementById('afEmail');
const afAction = document.getElementById('afAction');
const afFrom = document.getElementById('afFrom');
const afTo = document.getElementById('afTo');
const btnAuditSearch = document.getElementById('btnAuditSearch');
const btnAuditReset = document.getElementById('btnAuditReset');
const btnAuditRefresh = document.getElementById('btnAuditRefresh');
const btnAuditPrev = document.getElementById('btnAuditPrev');
const btnAuditNext = document.getElementById('btnAuditNext');
const auditBody = document.getElementById('auditBody');
const auditPageCur = document.getElementById('auditPageCur');
const auditPageMax = document.getElementById('auditPageMax');
const auditCount = document.getElementById('auditCount');
const auditLast = document.getElementById('auditLast');

/* ---------- STATE ---------- */
let CURRENT_TABLE = null;
let COLUMNS = [];
let PKCOLUMNS = [];
let RAW_ROWS = [];
let ROW_BY_KEY = new Map();       // <<< ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≤‡∏° rowKey
let EDIT_BUFFER = new Map();

let CURRENT_ADMIN = { id: null, email: null };
let CURRENT_TAB = 'data';

let auditPage = 1;
let auditTotal = 0;

/* ---------- CLOCK + AUTH ---------- */

function tick(){
  const now = new Date();
  clock.innerHTML = `<span class="date">${fmtDate.format(now)}</span> <b class="time">${fmtTime.format(now)}</b>`;
}
tick();
setInterval(tick, 1000);

(async()=>{
  const { data: { user } } = await supabase.auth.getUser();
  CURRENT_ADMIN = { id: user?.id ?? null, email: user?.email ?? 'anonymous' };
  userEmail.textContent = CURRENT_ADMIN.email ?? 'anonymous';
})();

/* ---------- Tabs control ---------- */
function setDataActions(enabled){
  [btnAddRow, btnSaveEdits, btnDeleteRows].forEach(b=> b.disabled = !enabled);
  notice.textContent = enabled ? "" : "‚ÑπÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Äî ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ/‡∏•‡∏ö‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ";
}
function setTab(name){
  CURRENT_TAB = name;
  if(name==='data'){
    tabData.classList.add('active'); tabAudit.classList.remove('active');
    panelData.classList.add('active'); panelAudit.classList.remove('active');
    setDataActions(CURRENT_TABLE !== AUDIT_TABLE);
  }else{
    tabAudit.classList.add('active'); tabData.classList.remove('active');
    panelAudit.classList.add('active'); panelData.classList.remove('active');
    setDataActions(false);
    loadAudit(true);
  }
}
tabData.onclick = ()=> setTab('data');
tabAudit.onclick = ()=> setTab('audit');

/* ---------- Load tables ---------- */
async function loadTables(){
  tableSelect.innerHTML = `<option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</option>`;
  try{
    const { data, error } = await supabase.rpc('list_public_tables');
    if(error) throw error;
    tableSelect.innerHTML = `<option value="" disabled selected>‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‚Äî</option>` +
      data.map(r=>`<option value="${r.table_name}">${r.table_name} (${r.row_count})</option>`).join('');
    tableCount.textContent = data.length;
  }catch(e){
    tableSelect.innerHTML = `<option value="" disabled selected>‡∏™‡∏£‡πâ‡∏≤‡∏á RPC list_public_tables ‡∏Å‡πà‡∏≠‡∏ô</option>`;
    tableCount.textContent = '‚Äî';
    notice.textContent = "‚ÑπÔ∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á RPC 'list_public_tables', 'list_columns', 'list_primary_key'";
  }
}

/* ---------- Structure & Data ---------- */
async function loadStructure(table){
  const [cols, pk] = await Promise.all([
    supabase.rpc('list_columns', { p_table: table }),
    supabase.rpc('list_primary_key', { p_table: table })
  ]);
  if(cols.error) throw cols.error;
  if(pk.error) throw pk.error;
  COLUMNS = cols.data || [];
  PKCOLUMNS = (pk.data || []).map(x=>x.column_name);
}
async function loadData(){
  if(!CURRENT_TABLE) return;
  tbody.innerHTML = `<tr><td style="padding:12px" class="muted">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</td></tr>`;
  EDIT_BUFFER.clear();
  const { data, error } = await supabase
    .from(CURRENT_TABLE).select('*')
    .limit(200)
    .order(PKCOLUMNS[0] || COLUMNS[0]?.column_name, {ascending:false});
  if(error){ tbody.innerHTML = `<tr><td style="padding:12px">‚ùå ${error.message}</td></tr>`; return; }
  RAW_ROWS = data || [];
  buildRowMap();                    // <<< ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á
  renderTable();
  lastUpdate.textContent = fmtFull.format(new Date());
}
function renderTable(){
  const headCols = ['','_rowKey', ...COLUMNS.map(c=>c.column_name)];
  thead.innerHTML = `<tr>${headCols.map((h,i)=> {
    if(i===0) return `<th style="width:44px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>`;
    if(i===1) return `<th class="mono" style="min-width:120px">PK</th>`;
    return `<th class="nowrap">${h}</th>`;
  }).join('')}</tr>`;

  const q = (search.value || '').toLowerCase();
  const rows = RAW_ROWS.filter(obj=>{
    if(!q) return true;
    return Object.values(obj).some(v=> String(v??'').toLowerCase().includes(q));
  });

  if(rows.length===0){
    tbody.innerHTML = `<tr><td style="padding:12px" class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;
  }else{
    const isAuditTable = (CURRENT_TABLE === AUDIT_TABLE);
    tbody.innerHTML = rows.map(row=>{
      const rowKey = getRowKey(row);
      const tds = COLUMNS.map(col=>{
        const colName = col.column_name;
        const val = row[colName];
        const editable = !PKCOLUMNS.includes(colName) && !isAuditTable;
        return `<td contenteditable="${editable}" data-col="${colName}" data-rowkey="${rowKey}">${escapeHTML(val)}</td>`;
      }).join('');
      return `<tr>
        <td style="text-align:center"><input type="checkbox" class="row-select" data-rowkey="${rowKey}" ${isAuditTable?'disabled':''}></td>
        <td class="mono">${rowKey}</td>
        ${tds}
      </tr>`;
    }).join('');
  }
  countLabel.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡πÅ‡∏ñ‡∏ß (‡∏à‡∏≤‡∏Å ${RAW_ROWS.length})`;
  setDataActions(CURRENT_TAB==='data' && CURRENT_TABLE !== AUDIT_TABLE);
}

/* ---------- Utils ---------- */
function escapeHTML(v){ if(v===null || v===undefined) return ''; return String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function getRowKey(row){
  if(PKCOLUMNS.length===0){
    return 'ROW-' + JSON.stringify(row).length + '-' + Object.values(row).join('|').length;
  }
  return PKCOLUMNS.map(pk=>`${pk}:${row[pk]}`).join('|');
}
function parseRowKey(rowKey){ const obj = {}; rowKey.split('|').forEach(pair=>{ const [k,...rest] = pair.split(':'); obj[k] = rest.join(':'); }); return obj; }

/* map ‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á‡∏ï‡∏≤‡∏° rowKey */
function buildRowMap(){
  ROW_BY_KEY = new Map();
  for(const r of RAW_ROWS){
    ROW_BY_KEY.set(getRowKey(r), r);
  }
}
/* ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå PK ‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (number/uuid/‚Ä¶) */
function getPkObjFromRow(row){
  const pk = {};
  for(const k of PKCOLUMNS){ pk[k] = row[k]; }
  return pk;
}

/* ---------- Audit helpers ---------- */
function toISOLocal(dtLocal){ if(!dtLocal) return null; const dt = new Date(dtLocal); return dt.toISOString(); }
function renderDiffCell(diff){ if(!diff || typeof diff !== 'object' || Object.keys(diff).length===0){ return '<span class="muted">‚Äî</span>'; } const lines = []; for(const k of Object.keys(diff)){ const o = diff[k]?.old, n = diff[k]?.new; lines.push(`<div><span class="k">${escapeHTML(k)}</span>: <span class="v-old">- ${escapeHTML(o)}</span> ‚Üí <span class="v-new">+ ${escapeHTML(n)}</span></div>`);} return `<div class="diff">${lines.join('')}</div>`; }
function renderMetaCell(meta){ if(!meta) return '<span class="muted">‚Äî</span>'; try{ const j = typeof meta === 'string' ? JSON.parse(meta) : meta; const kv = Object.entries(j).map(([k,v])=>`<div><span class="k">${escapeHTML(k)}</span>: ${escapeHTML(typeof v==='object'? JSON.stringify(v): String(v))}</div>`); return `<div style="font-size:13px">${kv.join('')}</div>`; }catch(_){ return `<span class="mono">${escapeHTML(String(meta))}</span>`; }}
function fmtTS(ts){ try{ return fmtFull.format(new Date(ts)); }catch{ return ts } }

/* ---------- DATA actions (‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°) ---------- */
btnRefresh.onclick = async ()=>{ if(!CURRENT_TABLE) return; await loadStructure(CURRENT_TABLE); await loadData(); };
btnLogout.onclick  = async ()=>{ await supabase.auth.signOut(); window.location.href = "admin/signin.html"; };
search.addEventListener('input', renderTable);
tableSelect.addEventListener('change', async ()=>{
  CURRENT_TABLE = tableSelect.value;
  notice.textContent = (CURRENT_TABLE===AUDIT_TABLE) ? "‚ÑπÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á audit_logs ‚Äî ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ/‡∏•‡∏ö)" : "";
  await loadStructure(CURRENT_TABLE); await loadData();
});

/* ‡πÄ‡∏Å‡πá‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏á EDIT_BUFFER */
tbody.addEventListener('input', (e)=>{
  const td = e.target.closest('td[contenteditable="true"]');
  if(!td) return;
  const col = td.dataset.col;
  const rowKey = td.dataset.rowkey;
  const cur = EDIT_BUFFER.get(rowKey) || {};
  cur[col] = td.textContent;
  EDIT_BUFFER.set(rowKey, cur);
  td.style.background = 'rgba(147,197,253,.25)';
});

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß */
btnAddRow.onclick = async ()=>{
  if(!CURRENT_TABLE){ notice.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô"; return; }
  if(CURRENT_TABLE===AUDIT_TABLE){ notice.textContent="‡∏ï‡∏≤‡∏£‡∏≤‡∏á audit ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"; return; }

  const newRow = {};
  for(const c of COLUMNS){
    if(PKCOLUMNS.includes(c.column_name)) continue;
    newRow[c.column_name] = null;
  }
  const { error } = await supabase.from(CURRENT_TABLE).insert(newRow).select();
  if(error){ notice.textContent = `‚ùå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`; return; }
  await loadData();
  notice.textContent = "‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß";
};

/* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚Äî ‡πÉ‡∏ä‡πâ PK ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á) */
btnSaveEdits.onclick = async ()=>{
  if(!CURRENT_TABLE){ notice.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô"; return; }
  if(EDIT_BUFFER.size===0){ notice.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"; return; }

  btnSaveEdits.disabled = true;
  let ok=0, fail=0, msg=[];
  for(const [rowKey, changes] of EDIT_BUFFER){
    const row = ROW_BY_KEY.get(rowKey);
    if(!row){ fail++; msg.push(`‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏ö: ${rowKey}`); continue; }
    const pkObj = getPkObjFromRow(row);
    const { error } = await supabase.from(CURRENT_TABLE).update(changes).match(pkObj);
    if(error){ fail++; msg.push(error.message); } else ok++;
  }
  EDIT_BUFFER.clear();
  await loadData();
  btnSaveEdits.disabled = false;
  notice.textContent = `üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${ok} ‡πÅ‡∏ñ‡∏ß${fail?`, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${fail}: ${msg[0]||''}`:''}`;
};

/* ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äî ‡πÉ‡∏ä‡πâ PK ‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤ audit) */
btnDeleteRows.onclick = async ()=>{
  if(!CURRENT_TABLE){ notice.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô"; return; }
  const checks = [...document.querySelectorAll('.row-select:checked')];
  if(checks.length===0){ notice.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß"; return; }
  if(!confirm(`‡∏•‡∏ö ${checks.length} ‡πÅ‡∏ñ‡∏ß?`)) return;

  btnDeleteRows.disabled = true;
  let ok=0, fail=0, msg=[];
  for(const ch of checks){
    const rowKey = ch.dataset.rowkey;
    const row = ROW_BY_KEY.get(rowKey);
    if(!row){ fail++; msg.push(`‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πà‡∏û‡∏ö: ${rowKey}`); continue; }
    const pkObj = getPkObjFromRow(row);
    const { error } = await supabase.from(CURRENT_TABLE).delete().match(pkObj);
    if(error){ fail++; msg.push(error.message); } else ok++;
  }
  btnDeleteRows.disabled = false;
  await loadData();
  notice.textContent = `üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${ok} ‡πÅ‡∏ñ‡∏ß${fail?`, ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ${fail}: ${msg[0]||''}`:''}`;
};

/* ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV */
function toCSV(rows){
  const cols = COLUMNS.map(c=>c.column_name);
  const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
  const header = cols.map(esc).join(',');
  const body = rows.map(r=> cols.map(c=> esc(r[c])).join(',')).join('\n');
  return header + '\n' + body;
}
btnExport.onclick = async ()=>{
  if(!CURRENT_TABLE){ notice.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô"; return; }
  const { data, error } = await supabase.from(CURRENT_TABLE).select('*');
  if(error){ notice.textContent = `‚ùå ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`; return; }
  const csv = toCSV(data||[]);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${CURRENT_TABLE}-${new Date().toISOString().slice(0,19)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
};

/* ---------- AUDIT VIEW ---------- */
function fmtTSOrBlank(r){
  return r.event_ts || r.created_at || r.inserted_at || '';
}
async function fetchAudit({orderBy}){
  const fromISO = toISOLocal(afFrom.value);
  const toISO = toISOLocal(afTo.value);

  let countQ = supabase.from(AUDIT_TABLE).select('id', { count:'exact', head:true });
  if(afTable.value) countQ = countQ.eq('target_table', afTable.value.trim());
  if(afEmail.value) countQ = countQ.eq('admin_email', afEmail.value.trim());
  if(afAction.value) countQ = countQ.eq('action', afAction.value);
  if(orderBy && fromISO) countQ = countQ.gte(orderBy, fromISO);
  if(orderBy && toISO)   countQ = countQ.lte(orderBy, toISO);
  const ct = await countQ;
  if(!ct.error && typeof ct.count === 'number') auditTotal = ct.count;

  const from = (auditPage-1)*AUDIT_PAGE_SIZE;
  const to = from + AUDIT_PAGE_SIZE - 1;

  let q = supabase.from(AUDIT_TABLE).select('*').range(from, to);
  if(orderBy) q = q.order(orderBy, { ascending:false });

  if(afTable.value) q = q.eq('target_table', afTable.value.trim());
  if(afEmail.value) q = q.eq('admin_email', afEmail.value.trim());
  if(afAction.value) q = q.eq('action', afAction.value);
  if(orderBy && fromISO) q = q.gte(orderBy, fromISO);
  if(orderBy && toISO)   q = q.lte(orderBy, toISO);

  return await q;
}
async function loadAudit(reset=false){
  if(reset) auditPage = 1;

  let data=null, error=null;
  for(const col of AUDIT_ORDER_PREF){
    const r = await fetchAudit({orderBy: col});
    if(!r.error){ data = r.data; break; }
    if(!/does not exist/i.test(r.error?.message||'')){ error = r.error; break; }
  }
  if(!data && !error){
    const r = await fetchAudit({orderBy: null});
    data = r.data; error = r.error;
  }
  if(error){
    auditBody.innerHTML = `<tr><td style="padding:12px">‚ùå ${error.message}</td></tr>`;
    return;
  }

  if(!data || data.length===0){
    auditBody.innerHTML = `<tr><td class="muted" style="padding:12px">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</td></tr>`;
  }else{
    auditBody.innerHTML = data.map(r=>{
      const changed = Array.isArray(r.changed_columns) ? r.changed_columns.join(', ') : (r.changed_columns ?? '‚Äî');
      const pkShow = r.target_pk ?? '‚Äî';
      const ts = fmtTSOrBlank(r);
      return `<tr>
        <td class="mono">${fmtTS(ts)}</td>
        <td><div class="mono">${escapeHTML(r.admin_email ?? '‚Äî')}</div><div class="muted mono" style="font-size:12px">${escapeHTML(r.admin_id ?? '')}</div></td>
        <td><span class="pill">${escapeHTML(r.action)}</span></td>
        <td><div><b>${escapeHTML(r.target_table)}</b></div><div class="mono muted" style="font-size:12px">${escapeHTML(pkShow)}</div></td>
        <td>${escapeHTML(changed)}</td>
        <td>${renderDiffCell(r.diff)}</td>
        <td>${renderMetaCell(r.meta)}</td>
      </tr>`;
    }).join('');
  }

  const pageMax = Math.max(1, Math.ceil((auditTotal || data.length) / AUDIT_PAGE_SIZE));
  auditPageMax.textContent = String(pageMax);
  auditPageCur.textContent = String(Math.min(auditPage, pageMax));
  auditCount.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${auditTotal ?? data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  auditLast.textContent = fmtFull.format(new Date());
}

/* Audit events */
btnAuditSearch.onclick = ()=> loadAudit(true);
btnAuditReset.onclick = ()=>{ afTable.value=''; afEmail.value=''; afAction.value=''; afFrom.value=''; afTo.value=''; loadAudit(true); };
btnAuditRefresh.onclick = ()=> loadAudit(false);
btnAuditPrev.onclick = ()=>{ if(auditPage>1){ auditPage--; loadAudit(false); } };
btnAuditNext.onclick = ()=>{ const pageMax = Math.max(1, Math.ceil((auditTotal||0) / AUDIT_PAGE_SIZE)); if(auditPage<pageMax){ auditPage++; loadAudit(false); } };

/* ---------- INIT ---------- */
(async()=>{ await loadTables(); })();
</script>
</body>
</html>
